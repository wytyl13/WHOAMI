# health report fast api

## request

```
request url: http://192.168.12.18:8000/sleep_indices (局域网)

request json:
{
	"device_sn": ["13D7F349200080712111150807", "13D1F349200080712111151107"], # 设备编号（字符串或list）
	"query_date": "2024-12-25" # 日期
}

response json:
{
	"code": 200,
	"data": "To start process background. It will take approximately 3.0 minutes.",
	"is_error": false,
	"is_success": true,
	"extra": null,
	"time_stamp": 1735290362.7962584
}

后台自动处理并将处理结果写入数据库

```

## result details

```
# 绘图数据起始时间戳区间固定
{
    'total_num_second_on_bed': 38342, # 总在床时长（秒）
    'sleep_second': 28559,  # 睡眠时长（秒）
    'deep_sleep_second': 6734, # 深度睡眠时长（秒）
    'waking_second': 8802,  # 清醒时长（秒）
    'to_sleep_second': 1956.6, # 入睡时长（秒）
    'total_num_hour_on_bed': '10小时39分钟', # 总在床时长（小时）
    'sleep_hour': '7小时55分钟',  # 睡眠时长（小时）
    'deep_sleep_hour': '1小时52分钟',  # 深度睡眠时长（小时）
    'waking_hour': '2小时26分钟',  # 清醒时长（小时）
    'to_sleep_hour': '0小时32分钟', # 入睡时长（小时）
    'waking_count': 5,  # 夜醒次数
    'on_bed_time': '2024-12-24 20:54:35',  # 上床时间（节点）
    'sleep_time': '2024-12-24 21:10:55',  # 入睡时间（节点）
    'waking_time': '2024-12-25 08:28:51',  # 醒来时间（节点）
    'sleep_stage_image_x_y': '[[[1735044875, 1735045854], [1735045855, 1735047327], [1735047328, 1735053674], [1735053675, 1735055272], [1735055273, 1735055917], [1735055918, 1735058970], [1735058971, 1735060065], [1735060066, 1735060977], [1735060978, 1735062574], [1735062604, 1735064702], [1735064703, 1735066591], [1735066592, 1735070342], [1735070343, 1735071322], [1735071323, 1735074111], [1735074112, 1735075278], [1735075279, 1735077295], [1735077296, 1735077899], [1735077900, 1735080461], [1735080462, 1735081051], [1735081052, 1735083337], [1735083338, 1735084775], [1735084776, 1735085585], [1735085586, 1735086531], [1735086532, 1735088399]], [3, 2, 3, 2, 1, 2, 1, 2, 1, 2, 1, 2, 1, 2, 1, 2, 3, 2, 1, 2, 3, 2, 3, 4]]',  # 睡眠分区绘图
    'sleep_efficiency': 0.74, # 睡眠效率
    'deep_sleep_efficiency': 0.24, # 深睡效率
    'leave_count': 0,  # 离床次数
    'leave_bed_time': '2024-12-25 08:59:59',  # 离床时间
    'total_num_second': 43581,  # 总监测时长（秒）
    'total_num_hour': '12小时6分钟',  # 总监测时长（小时）
    'query_date': '2024-12-25',  # 查询日期
    'save_file_path': 'none',  # 绘图url
    'device_sn': '13D7F349200080712111150807', # 设备编号
    'average_breath_bpm': 14.07,  # 平均呼吸率
    'max_breath_bpm': 23.01,  # 最大呼吸率
    'min_breath_bpm': 8.44,  # 最小呼吸率
    'average_heart_bpm': 87.67,  # 平均心率
    'max_heart_bpm': 121.88,  # 最大心率
    'min_heart_bpm': 6.0,  # 最小心率
    'body_move_count': 336,  # 体动次数
    'body_move_exponent': 11.2,  # 体动指数
    'body_move_image_x_y': '[[1735044604, 1735046645, 1735048443, 1735050241, 1735052039, 1735053837, 1735055635, 1735057433, 1735059231, 1735061029, 1735062827, 1735064625, 1735066423, 1735068221, 1735070019, 1735071817, 1735073615, 1735075413, 1735077211, 1735079009, 1735080807, 1735082605, 1735084403, 1735086201, 1735087999, 1735088399], [0, 22, 18, 25, 26, 26, 9, 4, 15, 10, 22, 10, 16, 5, 6, 0, 16, 4, 6, 20, 12, 5, 23, 34, 2, 0]]', # 体动绘图
    'breath_exception_count': 0,  # 呼吸异常次数
    'breath_exception_image_x_y': '[[1735044604, 1735088399], [0, 0]]',  # 呼吸异常绘图
    'score': 56.26,  # 评分
    'score_name': '较差', # 评分归类
    "consist_count_waking": 1, # 连续?晚夜醒时长超过31分钟
    "consist_count_sleep_efficiency": 1, # 连续?晚睡眠效率小于80%
}
```

## 开发日志
```
# 对原始数据的理解
1 body_move_data != 0 体动  体动情况下有心率呼吸率数据，因此也要对体动进行睡眠分区
2 distance 和 signal_intensity 成正比 但是不绝对（存在有距离但是信号强度为0的情况）
3 信号强度signal_intensity（未使用）信号强度为0时离床
    信号强度不为0一定有数据，距离不为0不一定有数据，信号为0也可能有数据（但是少数13D2F34920008071211195ED07）
    signal_intensity == 0 and state == 0 不存在
    signal_intensity == 0 and breath_bpm != 0 不存在
    signal_intensity == 0 and inout_bed == 1 存在少数（13D2F34920008071211195ED07）
    signal_intensity != 0 and inout_bed == 0 存在少数（13D4F349200080712111955907）
    signal_intensity != 0 and breath_bpm == 0 存在少数但是属于憋气状态（因此根据信号强度来判断在离床最准确）
    signal_intensity == 0 and inout_bed is none 存在多数
    signal_intensity == 0 and in_out_bed is none and breath_bpm != 0 存在少数（可以忽略）
4 in_out_bed 在离床
    in_out_bed == 1 and heart_bpm == 0 不存在
    in_out_bed == 0 and heart_bpm != 0 不存在
    in_out_bed is none and heart_bpm != 0 存在多数
5 决定：在离床判断条件 
    signal_intensity == 0 and inout_bed != 1  离床
    signal_intensity !=0 or (signal_intensity == 0 and inout_bed == 1) 在床
6 state稳定性（未使用，通过分析原始数据发现，该稳定性数值本身并不稳定）
    signal_intensity=0 and state=0 数据不稳定
    刚开始使用其判断体动，后引入体动动量值指标，所以抛弃
7 睡眠分区要基于在床数据进行分析
    1 首先对原始数据使用4条件分类为离床和在床
    2 基于在床数据做睡眠分区并统计睡眠数据
        2.1 使用统计方式睡眠分区
            首先根据整个统计数据计算得到呼吸率和心率对应的醒来阈值、深睡自适应阈值
                滑动窗口扫描计算所有呼吸率、心率数据的std或其他可以描述数据波动性的统计数据
                然后取75分位数std作为醒来阈值，取25分位数作为深睡阈值
            然后使用窗口扫描办法进行固定时间段的睡眠分区（如：30秒，300秒，600秒，900秒），扫描办法一般采用窗口重叠，这样可以尽可能保证睡眠阶段变换的平稳性
                对单个窗口采用统计方法进行统计指标计算（如std），得到每个分段数据的std
                和自适应阈值比较进行该分段数据的睡眠分区
            最后对分区数据进行平滑处理，对扫描区域的数据使用中位数处理
        2.2 使用多参数信息融合的方式睡眠分区
            使用到的参数融合经验：健康成年人睡眠过程的规律、心动周期心率与睡眠时相的关系、呼吸率与睡眠时相的关系、体动与睡眠时相的关系
            不同睡眠时期心率周期经验
                NERMS比醒觉时心率慢10~30次/分钟，深睡期心率最低且稳定
                REMS的心率较NREMS快、尤其是N3以后的REMS心率升高更为显著
                当REMS的持续时间大于20~30分钟时，心率通常不会保持在高水平，而会发生较大的起伏震荡（周期为20分钟左右）
            不同睡眠时期心动周期经验
                时相转换时常会有较明显的变化，但是在时相内变化幅度相对较小，持续时间也短
                从NREMS进入REMS时，心动周期的下降呈缓坡状，约在6~10分钟内降到底部
                从NREMS到醒觉，一般伴随心动周期的突降（15秒内）
            不同睡眠时期心动周期趋势
                平稳型：周期性明显，初始提示睡眠较好
                上升型：NREMS的心动周期水平随着睡眠的延续而上升，且其间没有20分钟以上的觉醒
                弧线型：NREMS的心动周期水平先上升后下降，存在弧线的顶部发生较长时间（20分钟）的醒觉的可能性
            睡眠中呼吸周期的变化
                NREMS的呼吸率较慢且平稳，尤其在深睡期最为平稳，该规律可靠性较高
                REMS呼吸较快且不平稳
                呼吸率随着NREMS和REMS的更替而起伏变化
            睡眠中体动
                觉醒时体动的幅度和频度均较大
                在N2和REMS期，体动都会发生
                睡眠状态中的体动通常较为短促且幅度较小
                体动信息对于确定入睡时间、晨醒时间、辨别深睡浅睡、REMS和醒都有所帮助
            睡眠结构相关知识：
                睡眠时相：醒觉、REMS（快速眼动睡眠）、NREMS（非快速眼动睡眠）
                睡眠分区：醒觉、REMS（快速眼动睡眠）、浅睡眠（非快速眼动睡眠）、深度睡眠（非快速眼动睡眠）
            分区步骤：
                1 首先定义识别框架{醒觉, REMS, NREMS}
                2 定义规则，规则的输出为概率值（根据心率呼吸率数据和经验对每个计算单元进行基本概率赋值）
                    如：
                        醒觉状态下心动周期通常较短且波动较大
                            如根据经验对30S心率数据进行经验赋值：mr(wake)=0.3, mr(rems)=0.5, mr(nrems)=0.2
                            设计一个规则可信度，如该规则下可信度为0.8
                            基于该规则可信度0.8重新计算概率赋值 mr(wake)=0.3*0.8, mr(rems)=0.5*0.8, mr(nrems)=0.2*0.8
                            基于前件的可信度0.9重新计算概率赋值 mr(wake)=0.3*0.8*0.9, mr(rems)=0.5*0.8*0.9, mr(nrems)=0.2*0.8*0.9
                        醒觉状态呼吸较快且不规则
                        醒觉时体动频繁且幅度大
                    最终将所有规则的概率进行汇总求和后得到概率最大的分区作为最终分区结果。
                    详细概率计算步骤：
                        从整晚的心动或呼吸周期数据中提取与睡眠结构相关的信息
                            高频变化信息0.1Hz（0.15Hz~0.4Hz）
                            整体的动态变化 0.5Hz
                            紧支集SYMLET小波分别对心率和呼吸率序列数据作0.5和0.1Hz的采样处理，然后作小波变换取概貌信号A3、A4分析整夜的变化趋势，细节信号D2、D3分析心动周期的高频成分的波动性
                        基于整晚参数趋势图波形分析的睡眠信息提取
                            搜索概貌趋势图A3和A4中的下降波，按下降的幅度（由高到低）和下降的谷底（由低到高）进行排序
                            将整个趋势图以 ｛很高，较高，中间值，较低，很低｝ 描述幅值并进行分段。
                        基于心动和呼吸周期平稳度分析的睡眠信息提取
                            规则如下：
                                {很大，较大，较小，很小}, {0.6, 0.7, 0.8, 0.9}
                                如果心动和呼吸周期平稳度均为很小 and 持续时间大于15分钟
                                    m({wake,rems})=0.1, m(nrems)=0.9(0.9) wake或rems的概率值为0.1，nrems的概率为0.9，该规则的可靠度为0.9
                                如果心动和呼吸周期平稳度均为较小 and 持续时间大于15分钟
                                    m({wake,rems})=0.1, m(nrems)=0.9(0.8) wake或rems的概率值为0.1，nrems的概率为0.9，该规则的可靠度为0.8
                3 使用上述同样的规则对NREMS区分深睡和浅睡（NREMS）
        2.3 使用机器学习方式睡眠分区
            准备呼吸率和心率的时序数据，并采用合适的分区时间（30秒），对每30秒数据做睡眠分区标注
            将数据输入到模型进行预训练
            2.3.1 睡眠指标计算SOTA（时序数据分类深度学习方法）
                采样数据时间为：20:00-10:00
                BAS（脑电图） 通道为 10 个，ECG（心电图） 通道为 2 个，SDB（呼吸数据）通道为 7 个。
                将采样数据分割为连续的30秒片段，保证输入数据的维度
                输入数据维度：30*10, 30*2, 30*7 --> CNN --> EMBEDDING BAS_embedding_size, ECG_embedding_size, SDB_embedding_size --> 对比学习 BAS_embedding_size vs ECG_embedding_size, BAS_embedding_size vs SDB_embedding_size, ECG_embedding_size vs SDB_embedding_size (无监督学习，同一时序为正样本，不同时序为负样本，使用交叉熵损失函数（先求对比正负样本的相似度（可以是余弦相似度），然后使用交叉熵或者KL散度计算两个概率分布的距离）)--> 添加分类头（使用MLP）3*embedding_size --> classic_size(监督学习，睡眠区间类别数) 
                其中 SDB_embedding_size = BAS_embedding_size = ECG_embedding_size = embedding_size（嵌入维度）
                注意对比学习只是无监督学习的一个策略，目的是通过自动设置正负样本来制造损失函数
                对比学习的目的是优化嵌入模型参数，使得正样本嵌入后的特征更接近正样本，越远离负样本。比如一个批次是10
                那么对应的每个批次的嵌入维度是10, 3, 512; batch_size, modal_size(BAS, ECG, SDB), embedding_size.
                如A_1, B_1, C_1, A_2, B2_, C2 ... A_10, B_10, C_10
                自定义正负样本对  
                正样本对 (A_1, B_1) (A_1, C_1) (B_1, C_1) 
                负样本对 (A_1, B_2), (A_2, C_1), (B_1, C_2)
                然后使用对比学习策略制作正样本和负样本，我们首先需要定义正负样本，然后使用损失函数loss = -log(e^(sim(x_i, x_j) / r) / ∑(e^(sim(x_i, x_k) / r)))
                注意sim(x_i, x_j) 肯定很高，因为是同意时间段的。注意分子只是当前正样本对的相似度的指数，分母是正负样本对的相似度指数求和，这样计算得到的是每一个正样本对的损失
                注意r为温度系数, (x_i和x_j)为正样本对的嵌入向量，(x_i和x_k)是所有样本对的嵌入向量（包括正负样本对）
                最后将所有正样本对计算得到的损失值求和就是当前批次的损失之，然后梯度优化这个损失函数即可将embedding模型的参数推理得到的正样本的嵌入特征更接近正样本，越远离负样本
8 然后基于在床数据去进行体动统计
    signal_intensity is none and body_move_data is not none 体动
    查询对应的device_sn和create_time然后将对应的体动数据赋值给对应的条目
    统计一个总体动次数
    以20分钟为一个批次统计体动次数并报告统计数据
9 判断呼吸异常事件
    呼吸异常 "breath_bpm": [10, 22]  标准区间，该标准区间由后端使用数据库维护
    不在区间范围内定义为呼吸异常，报告该呼吸异常60秒内的呼吸率数据
    连续呼吸异常大于一定的时间阈值并且在这期间信号强度稳定的可以界定被监测人死亡
```
v1.0 
完成：在离床  

已完成：
1、各项基本指标的获得
2、基于统计方法的睡眠分区
3、简单的睡眠建议

下一步：
1、使用体动能量值这个数据区进行体动数据的分析
2、优化统计方法的睡眠分区算法，然后得到真正的标注数据
3、使用标注数据和时间序列深度学习模型训练预训练睡眠分区模型
4、更为精细的睡眠建议和更深入的健康建议
```
